<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Entrega</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDKYVXlZuKkYFeYKYNAYEz393La5Erl12c",
            authDomain: "flotilla-d9efb.firebaseapp.com",
            databaseURL: "https://flotilla-d9efb-default-rtdb.firebaseio.com",
            projectId: "flotilla-d9efb",
            storageBucket: "flotilla-d9efb.appspot.com",
            messagingSenderId: "357309099599",
            appId: "1:357309099599:web:d449d44db6f602c2d9c43a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('crearEntrega').addEventListener('click', async () => {
                const idCamion = document.getElementById('idCamion').value;
                const idConductor = document.getElementById('idConductor').value;
                const ubicacionInicial = document.getElementById('ubicacionInicial').value;
                const ubicacionFinal = document.getElementById('ubicacionFinal').value;
                const fechaInicial = document.getElementById('fechaInicial').value;
                const fechaFinal = document.getElementById('fechaFinal').value;
                const estado = document.getElementById('estado').value;
                const descripcion = document.getElementById('descripcion').value;
                const fotoFile = document.getElementById('fotoEntrega').files[0];

                const idEntrega = push(ref(db, 'entregas')).key;

                try {
                    // Subir la imagen a Firebase Storage
                    const storageReference = storageRef(storage, 'entregas/' + idEntrega + '/foto.jpg');
                    await uploadBytes(storageReference, fotoFile);
                    const photoURL = await getDownloadURL(storageReference);

                    // Guardar la entrega en la base de datos
                    await set(ref(db, 'entregas/' + idEntrega), {
                        idCamion,
                        idConductor,
                        ubicacionInicial,
                        ubicacionFinal,
                        fechaInicial,
                        fechaFinal,
                        estado,
                        descripcion,
                        fotoURL: photoURL
                    });

                    alert('Entrega creada con éxito');
                    document.getElementById('entregaForm').reset();
                } catch (error) {
                    alert('Error al crear la entrega');
                    console.error(error);
                }
            });
        });
    </script>
</head>
<body>
    <h1>Agregar Entrega</h1>
    <form id="entregaForm">
        <label for="idCamion">ID Camión:</label>
        <input type="text" id="idCamion" required><br>
        <label for="idConductor">ID Conductor:</label>
        <input type="text" id="idConductor" required><br>
        <label for="ubicacionInicial">Ubicación Inicial:</label>
        <input type="text" id="ubicacionInicial" required><br>
        <label for="ubicacionFinal">Ubicación Final:</label>
        <input type="text" id="ubicacionFinal" required><br>
        <label for="fechaInicial">Fecha Inicial:</label>
        <input type="date" id="fechaInicial" required><br>
        <label for="fechaFinal">Fecha Final:</label>
        <input type="date" id="fechaFinal" required><br>
        <label for="estado">Estado:</label>
        <select id="estado" required>
            <option value="recibido">Recibido</option>
            <option value="en curso">En Curso</option>
            <option value="finalizado">Finalizado</option>
        </select><br>
        <label for="descripcion">Descripción:</label>
        <textarea id="descripcion" required></textarea><br>
        <label for="fotoEntrega">Foto de la Entrega:</label>
        <input type="file" id="fotoEntrega" required><br>
        <button type="button" id="crearEntrega">Crear Entrega</button>
    </form>
</body>
</html>
